{% extends 'base.html' %}
{% load static %}

{% block title %}{{ post.title }} - SecretTreehole{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <!-- 帖子内容 -->
        <div class="card mb-4">
            <div class="card-body">
                <h1 class="card-title mb-3">{{ post.title }}</h1>
                
                <div class="post-meta mb-4">
                    <div class="d-flex align-items-center mb-2">
                        {% if post.author.avatar %}
                            <img src="{{ post.author.avatar.url }}" alt="头像" class="avatar me-2">
                        {% else %}
                            <div class="avatar-placeholder bg-secondary text-white rounded-circle d-inline-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;">
                                <i class="fas fa-user"></i>
                            </div>
                        {% endif %}
                        <div>
                            <div>
                                <strong>
                                    {% if post.is_anonymous %}匿名用户{% else %}{{ post.author.username }}{% endif %}
                                </strong>
                                {% if not post.is_anonymous and post.author %}
                                <a href="{% url 'profile_with_pk' post.author.pk %}" class="btn btn-sm btn-outline-primary ms-2">
                                    查看资料
                                </a>
                                {% endif %}
                            </div>
                            <small class="text-muted">
                                <i class="far fa-clock"></i> {{ post.created_at|date:"Y年m月d日 H:i" }}
                                {% if post.created_at|date:"YmdHis" != post.updated_at|date:"YmdHis" %}
                                (更新于 {{ post.updated_at|date:"m-d H:i" }})
                                {% endif %}
                            </small>
                        </div>
                    </div>

                    <div class="d-flex flex-wrap gap-2 mt-2">
                        {% if post.category %}
                        <a href="{% url 'post_list_by_category' post.category.slug %}" class="badge bg-primary text-decoration-none">
                            {{ post.category.name }}
                        </a>
                        {% endif %}
                        {% if post.is_anonymous %}
                        <span class="badge bg-info">匿名</span>
                        {% endif %}
                        {% if not post.allow_comments %}
                        <span class="badge bg-warning">评论已关闭</span>
                        {% endif %}
                        {% if post.status == 'draft' %}
                        <span class="badge bg-secondary">草稿</span>
                        {% elif post.status == 'hidden' %}
                        <span class="badge bg-danger">隐藏</span>
                        {% endif %}
                    </div>
                </div>

                <div class="post-content mb-4">
                    {{ post.content|linebreaks }}
                </div>

                <div class="d-flex justify-content-between align-items-center border-top pt-3">
                    <div>
                        <button class="btn btn-outline-danger like-btn {% if user_liked %}liked{% endif %}"
                                data-post-id="{{ post.id }}"
                                data-user-authenticated="{% if user.is_authenticated %}true{% else %}false{% endif %}">
                            <i class="{% if user_liked %}fas{% else %}far{% endif %} fa-heart"></i>
                            <span class="like-count">{{ post.like_count }}</span>
                        </button>

                        <a href="#comments" class="btn btn-outline-primary ms-2">
                            <i class="far fa-comment"></i> {{ post.comment_count }}
                        </a>
                    </div>

                    <div class="text-muted">
                        <small>
                            <i class="far fa-eye"></i> {{ post.view_count }} 次浏览
                        </small>
                    </div>
                </div>

                <!-- 帖子操作按钮 -->
                {% if user == post.author or user.is_staff %}
                <div class="border-top mt-3 pt-3">
                    <div class="btn-group">
                        <a href="{% url 'post_edit' post.pk %}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-edit"></i> 编辑
                        </a>
                        <a href="{% url 'post_delete' post.pk %}" class="btn btn-outline-danger btn-sm">
                            <i class="fas fa-trash"></i> 删除
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- 相关帖子 -->
        {% if related_posts %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">相关帖子</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for related_post in related_posts %}
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <a href="{% url 'post_detail' related_post.pk %}">{{ related_post.title }}</a>
                                </h6>
                                <p class="card-text small text-muted">
                                    {{ related_post.content|truncatechars:100 }}
                                </p>
                                <div class="d-flex justify-content-between small">
                                    <span>
                                        <i class="far fa-eye"></i> {{ related_post.view_count }}
                                    </span>
                                    <span>
                                        {{ related_post.created_at|date:"m-d" }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- 评论区域 -->
        <div class="card" id="comments">
            <div class="card-header">
                <h5 class="mb-0">评论 ({{ post.comment_count }})</h5>
            </div>
            <div class="card-body">
                {% if post.allow_comments %}
                    <!-- 评论表单 -->
                    {% if user.is_authenticated %}
                    <form method="post" action="{% url 'add_comment' post.id %}" class="mb-4">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="commentContent" class="form-label">发表评论</label>
                            <textarea class="form-control" id="commentContent" name="content" rows="3" placeholder="写下你的评论..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> 发表评论
                        </button>
                    </form>
                    {% else %}
                    <div class="alert alert-info">
                        请 <a href="{% url 'login' %}?next={{ request.path }}">登录</a> 后发表评论
                    </div>
                    {% endif %}
                {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-ban"></i> 该帖子已关闭评论
                    </div>
                {% endif %}

                <!-- 评论列表 -->
                <div class="comments-list">
                    {% for comment in comments %}
                    <div class="comment mb-3 pb-3 border-bottom">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                {% if comment.author.avatar %}
                                    <img src="{{ comment.author.avatar.url }}" alt="头像" class="avatar">
                                {% else %}
                                    <div class="avatar-placeholder bg-secondary text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                        <i class="fas fa-user"></i>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>
                                            <a href="{% url 'profile_with_pk' comment.author.pk %}" class="text-decoration-none text-dark">
                                                {{ comment.author.username }}
                                            </a>
                                        </strong>
                                        <small class="text-muted ms-2">
                                            {{ comment.created_at|date:"m-d H:i" }}
                                        </small>
                                    </div>
                                    {% if user == comment.author or user == post.author or user.is_staff %}
                                    <form method="post" action="{% url 'delete_comment' comment.id %}" class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('确定要删除这条评论吗？')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                    {% endif %}
                                </div>
                                <p class="mb-0 mt-2">{{ comment.content|linebreaks }}</p>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center text-muted py-4">
                        {% if post.allow_comments %}
                            <i class="far fa-comments fa-2x mb-3"></i>
                            <p>还没有评论，快来第一个评论吧！</p>
                        {% else %}
                            <i class="fas fa-comment-slash fa-2x mb-3"></i>
                            <p>评论功能已关闭</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- 作者信息 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">作者信息</h5>
            </div>
            <div class="card-body text-center">
                {% if not post.is_anonymous %}
                    {% if post.author.avatar %}
                        <img src="{{ post.author.avatar.url }}" alt="头像" class="avatar-large mb-3">
                    {% else %}
                        <div class="avatar-placeholder bg-secondary text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px; font-size: 30px;">
                            <i class="fas fa-user"></i>
                        </div>
                    {% endif %}
                    <h5>{{ post.author.username }}</h5>
                    <p class="text-muted">
                        发布于 {{ post.created_at|date:"Y年m月d日" }}
                        <br>
                        注册于 {{ post.author.date_joined|date:"Y年m月" }}
                    </p>

                    <div class="mt-3">
                        <a href="{% url 'profile_with_pk' post.author.pk %}" class="btn btn-outline-primary btn-sm">
                            查看个人资料
                        </a>
                    </div>

                    {% if post.author.bio %}
                    <div class="mt-3">
                        <h6>个人简介</h6>
                        <p class="small text-muted">{{ post.author.bio|truncatechars:100 }}</p>
                    </div>
                    {% endif %}

                    <div class="mt-3">
                        <div class="row text-center">
                            <div class="col-4">
                                <small class="text-muted">发帖数</small>
                                <h6 class="mb-0">{{ post.author.posts.count }}</h6>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">评论数</small>
                                <h6 class="mb-0">{{ post.author.comments.count }}</h6>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">点赞数</small>
                                <h6 class="mb-0">{{ post.author.likes.count }}</h6>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="text-center">
                        <div class="avatar-placeholder bg-secondary text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px; font-size: 30px;">
                            <i class="fas fa-user-secret"></i>
                        </div>
                        <h5>匿名用户</h5>
                        <p class="text-muted">选择匿名发布</p>
                        <small class="text-muted">为了保护隐私，作者选择了匿名发布此帖</small>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- 帖子信息 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">帖子信息</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <i class="fas fa-calendar me-2"></i>
                        发布时间：{{ post.created_at|date:"Y-m-d H:i" }}
                    </li>
                    {% if post.created_at|date:"YmdHis" != post.updated_at|date:"YmdHis" %}
                    <li class="mb-2">
                        <i class="fas fa-sync-alt me-2"></i>
                        更新时间：{{ post.updated_at|date:"Y-m-d H:i" }}
                    </li>
                    {% endif %}
                    {% if post.published_at %}
                    <li class="mb-2">
                        <i class="fas fa-check-circle me-2"></i>
                        发布时间：{{ post.published_at|date:"Y-m-d H:i" }}
                    </li>
                    {% endif %}
                    <li class="mb-2">
                        <i class="fas fa-eye me-2"></i>
                        浏览次数：{{ post.view_count }}
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-heart me-2"></i>
                        点赞数：{{ post.like_count }}
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-comment me-2"></i>
                        评论数：{{ post.comment_count }}
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-lock me-2"></i>
                        状态：{{ post.get_status_display }}
                    </li>
                    {% if post.category %}
                    <li class="mb-2">
                        <i class="fas fa-folder me-2"></i>
                        分类：<a href="{% url 'post_list_by_category' post.category.slug %}">{{ post.category.name }}</a>
                    </li>
                    {% endif %}
                    <li class="mb-2">
                        <i class="fas fa-comments me-2"></i>
                        评论状态：{% if post.allow_comments %}开放{% else %}关闭{% endif %}
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-user-secret me-2"></i>
                        匿名状态：{% if post.is_anonymous %}匿名发布{% else %}公开作者{% endif %}
                    </li>
                </ul>
            </div>
        </div>

        <!-- 操作指南 -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle"></i> 操作提示</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled small">
                    <li class="mb-2">
                        <i class="fas fa-heart text-danger me-2"></i>
                        点击❤️点赞帖子
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-comment text-primary me-2"></i>
                        在下方发表评论
                    </li>
                    {% if user == post.author %}
                    <li class="mb-2">
                        <i class="fas fa-edit text-success me-2"></i>
                        你可以编辑或删除此帖
                    </li>
                    {% endif %}
                    {% if user.is_authenticated and not post.allow_comments %}
                    <li class="mb-2 text-warning">
                        <i class="fas fa-ban me-2"></i>
                        此帖已关闭评论
                    </li>
                    {% endif %}
                    {% if post.is_anonymous %}
                    <li class="mb-2 text-info">
                        <i class="fas fa-user-secret me-2"></i>
                        此帖为匿名发布
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // 点赞功能
    $('.like-btn').click(function(e) {
        e.preventDefault();

        const isAuthenticated = $(this).data('user-authenticated') === 'true';
        if (!isAuthenticated) {
            window.location.href = '/accounts/login/?next=' + window.location.pathname;
            return;
        }

        const likeBtn = $(this);
        const postId = likeBtn.data('post-id');
        const likeUrl = `/interactions/like/${postId}/`;
        const likeCountSpan = likeBtn.find('.like-count');
        const icon = likeBtn.find('i');

        // 获取当前状态
        const isLiked = likeBtn.hasClass('liked');
        const currentCount = parseInt(likeCountSpan.text());

        // 立即更新UI
        if (isLiked) {
            likeBtn.removeClass('liked');
            icon.removeClass('fas').addClass('far');
            likeCountSpan.text(currentCount - 1);
        } else {
            likeBtn.addClass('liked');
            icon.removeClass('far').addClass('fas');
            likeCountSpan.text(currentCount + 1);
        }

        // 发送AJAX请求
        $.ajax({
            url: likeUrl,
            type: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                // 根据服务器响应更新
                likeCountSpan.text(response.like_count);
                if (response.liked) {
                    likeBtn.addClass('liked');
                    icon.removeClass('far').addClass('fas');
                } else {
                    likeBtn.removeClass('liked');
                    icon.removeClass('fas').addClass('far');
                }
            },
            error: function(xhr) {
                // 恢复UI状态
                if (isLiked) {
                    likeBtn.addClass('liked');
                    icon.removeClass('far').addClass('fas');
                    likeCountSpan.text(currentCount);
                } else {
                    likeBtn.removeClass('liked');
                    icon.removeClass('fas').addClass('far');
                    likeCountSpan.text(currentCount);
                }

                if (xhr.status === 401 || xhr.status === 403) {
                    window.location.href = '/accounts/login/?next=' + window.location.pathname;
                } else {
                    alert('操作失败，请刷新页面重试');
                }
            }
        });
    });

    // 评论表单字数限制
    $('#commentContent').on('input', function() {
        const length = $(this).val().length;
        const maxLength = 500;

        // 创建或更新计数器
        let counter = $(this).next('.char-counter');
        if (counter.length === 0) {
            counter = $('<small class="char-counter text-muted"></small>').insertAfter($(this));
        }

        counter.text(`${length}/${maxLength}`);

        if (length > maxLength) {
            counter.removeClass('text-muted').addClass('text-danger');
        } else {
            counter.removeClass('text-danger').addClass('text-muted');
        }
    });

    // 获取CSRF token的辅助函数
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // 页面滚动到评论区域
    if (window.location.hash === '#comments') {
        setTimeout(function() {
            document.getElementById('comments').scrollIntoView({ behavior: 'smooth' });
        }, 100);
    }

    // 显示帖子更新时间相对时间
    $('.post-updated-time').each(function() {
        const timestamp = $(this).data('timestamp');
        if (timestamp) {
            const time = new Date(timestamp);
            const now = new Date();
            const diffMs = now - time;
            const diffMins = Math.floor(diffMs / 60000);

            let relativeTime;
            if (diffMins < 1) {
                relativeTime = '刚刚';
            } else if (diffMins < 60) {
                relativeTime = `${diffMins}分钟前`;
            } else if (diffMins < 1440) {
                relativeTime = `${Math.floor(diffMins / 60)}小时前`;
            } else {
                relativeTime = `${Math.floor(diffMins / 1440)}天前`;
            }

            $(this).text(`(更新于 ${relativeTime})`);
        }
    });
});
</script>
{% endblock %}